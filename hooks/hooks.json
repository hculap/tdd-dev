{
  "description": "TDD enforcement hooks - validates that behavior-changing code has failing tests first",
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "You are the TDD enforcement validator. Check if this file write/edit should be allowed under TDD rules.\n\n**Tool Input:**\n$TOOL_INPUT\n\n**Step 1: Check if TDD mode is active**\n\nLook for the flag file `.claude/.tdd-mode-active` in the project. This file is created by `/tdd-dev:start` and contains:\n```json\n{\"active\": true, \"strictness\": \"strict|standard|relaxed\", \"testCommand\": \"...\"}\n```\n\nIf this file does NOT exist or `active` is false:\n- Return: {\"decision\": \"approve\", \"reason\": \"TDD mode not active.\"}\n\n**Step 2: Check if this is a test file**\n\nFirst, check `.claude/tdd-dev.local.md` for custom patterns in YAML frontmatter:\n- If `testPatterns` is configured, use those globs to match test files\n- If not configured, use these defaults:\n  - `*.test.*`, `*.spec.*`\n  - `__tests__/*`\n  - `tests/*`, `test/*`\n  - `*_test.*`, `test_*.*`\n\nIf the file path matches test patterns:\nReturn: {\"decision\": \"approve\", \"reason\": \"Writing test file is always allowed in TDD.\"}\n\n**Step 3: Apply TDD rules for source files**\n\nFirst, check `.claude/tdd-dev.local.md` for custom patterns:\n- If `sourcePatterns` is configured, use those globs to identify source files\n- If not configured, use defaults: src/*, app/*, lib/*, *.ts, *.js, *.py, *.go, etc.\n\nFor source files, read the strictness from `.claude/.tdd-mode-active`:\n\n- **strict**: Check if there's evidence of a failing test for this change in the recent conversation. If no failing test exists:\n  Return: {\"decision\": \"deny\", \"reason\": \"TDD Strict Mode: Write a failing test first before implementing this change. Create the test, run it to see it fail, then implement.\"}\n\n- **standard**: Warn and ask for confirmation:\n  Return: {\"decision\": \"ask\", \"reason\": \"TDD Standard Mode: No failing test detected for this change. Proceed without test coverage?\"}\n\n- **relaxed**: Approve with coaching:\n  Return: {\"decision\": \"approve\", \"reason\": \"TDD Relaxed Mode: Consider writing a test first for better coverage.\", \"systemMessage\": \"Reminder: TDD recommends writing tests before implementation.\"}\n\n**Step 4: Default behavior**\n\nIf unsure about file type or TDD state, default to approve to avoid blocking legitimate work.\n\n**Response Format:**\nReturn JSON with:\n- `decision`: \"approve\", \"deny\", or \"ask\"\n- `reason`: Explanation for the decision\n- `systemMessage`: (optional) Additional context for Claude",
            "timeout": 30
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "You are the TDD completion validator. Verify the task was completed following TDD principles.\n\n**Step 1: Check if TDD mode is active**\n\nLook for `.claude/.tdd-mode-active` flag file. If it doesn't exist or `active` is false:\n- Return: {\"decision\": \"approve\", \"reason\": \"TDD mode not active, no validation needed.\"}\n\n**Step 2: Validate TDD compliance (when TDD mode is active)**\n\nCheck the conversation for evidence of TDD workflow:\n\n1. **Tests were written**: Were test files created or modified?\n2. **RED phase occurred**: Was there a failing test before implementation?\n3. **GREEN phase occurred**: Did tests pass after implementation?\n4. **No untested behavior changes**: Do all source file changes have corresponding tests?\n\n**Step 3: Make decision based on strictness**\n\nRead strictness from `.claude/.tdd-mode-active`:\n\n- **strict**: If TDD workflow was NOT followed:\n  Return: {\"decision\": \"block\", \"reason\": \"TDD cycle incomplete. Ensure: 1) Write failing test, 2) Implement to pass, 3) Refactor if needed.\", \"systemMessage\": \"Complete the TDD cycle before finishing.\"}\n\n- **standard**: If TDD workflow was NOT followed:\n  Return: {\"decision\": \"approve\", \"reason\": \"TDD workflow not detected. Consider adding test coverage for these changes.\", \"systemMessage\": \"Warning: Changes made without following TDD workflow.\"}\n\n- **relaxed**: Always approve but provide feedback:\n  Return: {\"decision\": \"approve\", \"reason\": \"Task complete.\", \"systemMessage\": \"TDD tip: Writing tests first leads to better design.\"}\n\n**Step 4: Approve if compliant**\n\nIf TDD workflow was followed:\nReturn: {\"decision\": \"approve\", \"reason\": \"TDD cycle completed successfully.\", \"systemMessage\": \"All behavior changes are test-protected.\"}\n\n**Response Format:**\nReturn JSON with:\n- `decision`: \"approve\" or \"block\"\n- `reason`: Explanation\n- `systemMessage`: (optional) Coaching message",
            "timeout": 30
          }
        ]
      }
    ]
  }
}
